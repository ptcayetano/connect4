var Utils={debug:function(){for(var e=arguments.length,r=0;r<e;r++){var t=arguments[r];switch(typeof t){case"object":console.dir(t);break;case"string":console.log(t)}}}};String.prototype.replaceAll=function(e,r){var t=this;return t.replace(new RegExp(e,"g"),r)};
var C4={view:{},model:{}};$(document).ready(function(){Utils.debug("Connect4 has started.");new C4.view.GameboardView});
C4.model.Player=function(){return Backbone.Model.extend({defaults:{name:"Player 1",id:"player1",color:"#3399ff"},move:function(e){Utils.debug(this.get("name")+" makes a move at column "+e),this.trigger("move",this.get("id"),e)}})}();
C4.view.GameboardView=function(){var e=function(e,i){var n="",r=0,t=0,a="<div class='board-row row'>GRID</div>",o="<div id='grid-ROW-COL' class='board-grid token-grid border-thin' data-row='ROW' data-col='COL'></div>";for(r=0;r<e;r++){var l="";for(t=0;t<i;t++){var s=o.replaceAll("ROW",r).replaceAll("COL",t);l+=s}n+=a.replaceAll("GRID",l)}return n},i=function(){var e="<div class='move-grid board-grid clickable' data-movenum='MOVE_NUM'></div>",i=0,n="";for(i=0;i<7;i++)n+=e.replaceAll("MOVE_NUM",i);return n},n=function(){return _infobox="<div class='infobox hidden'></div><div class='play-again clickable hidden'><a href='#'>play again</a></div>"};return Backbone.View.extend({el:"#gameboard",rowCount:6,colCount:7,player1:null,player2:null,activePlayer:null,winner:null,events:{"mouseover .move-grid":"focusMove","mouseout .move-grid":"outMove","click .move-grid":"makeMove","click .play-again a":"reset"},initialize:function(){Utils.debug("Initializing GameboardView."),_.bindAll(this,"render","placeToken","registerPlayer","makeMove","focusMove","outMove","checkWinner","announceWinner"),this.registerPlayer(),this.render()},render:function(){Utils.debug("Rendering GameboardView.");var r=n()+i()+e(this.rowCount,this.colCount);$(this.el).html(r)},reset:function(e){$(".board-grid.token-grid").data("active",!1).removeClass("player1 player2"),$(".move-grid").removeClass("hidden"),$(".infobox").addClass("hidden").html(""),$(".play-again").addClass("hidden"),this.winner=null,this.activePlayer=this.player1,Utils.debug("The game was reset!")},registerPlayer:function(){this.player1=new C4.model.Player({name:"Player 1",id:"player1",color:"#3399ff"}),this.player2=new C4.model.Player({name:"Player 2",id:"player2",color:"#ff9900"}),this.activePlayer=this.player1,this.listenTo(this.player1,"move",this.placeToken),this.listenTo(this.player2,"move",this.placeToken)},checkWinner:function(){for(var e=this.activePlayer.get("id"),i=0,n="",r=function(i){return o.data("active")&&o.hasClass(e)},t=0;t<this.colCount;t++){i=0,n="";for(var a=0;a<this.rowCount;a++){var o=this.getGrid(a,t);if(o.length>0&&(r(o)?(n+=a+","+t+" | ",i++):(n="",i=0)),4==i)return Utils.debug("Winning combination: "+n),this.announceWinner()}}for(var a=0;a<this.rowCount;a++){i=0,n="";for(var t=0;t<this.colCount;t++){var o=this.getGrid(a,t);if(o.length>0&&(r(o)?(n+=a+","+t+" | ",i++):(n="",i=0)),4==i)return Utils.debug("Winning combination: "+n),this.announceWinner()}}for(var a=0;a<this.rowCount;a++){var l=a;n="",i=0;for(var s=0;s<this.colCount;s++){var o=this.getGrid(l,s);if(o.length>0&&(r(o)?(n+=l+","+s+" | ",i++):(n="",i=0)),4==i)return Utils.debug("Winning combination: "+n),this.announceWinner();l++}}for(var t=0;t<this.colCount;t++){n="",i=0;for(var s=t+1,a=0;a<this.rowCount;a++){var o=this.getGrid(a,s);if(o.length>0&&(r(o)?(n+=a+","+s+"|",i++):(n="",i=0)),4==i)return Utils.debug("Winning combination: "+n),this.announceWinner();s++}}for(var a=0;a<this.rowCount;a++){var l=a;i=0,n=0;for(var t=this.colCount-1;t>=0;t--){var o=this.getGrid(l,t);if(o.length>0&&(r(o)?(n+=l+","+t+"|",i++):(n="",i=0)),4==i)return Utils.debug("Winning combination: "+n),this.announceWinner();l++}}for(var s=this.colCount-1,a=0;a<=this.rowCount;a++){i=0,n="";for(var l=0,t=s;t>=0;t--){var o=this.getGrid(l,t);o.length>0&&(r(o)?(n+=l+","+t+"|",i++):(n="",i=0)),l++}if(4==i)return Utils.debug("Winning combination: "+n),this.announceWinner();s--}var d=$(".board-grid.token-grid").length,h=$(".board-grid."+this.player1.id).length,c=$(".board-grid."+this.player2.id).length;d==h+c&&this.announceDraw()},toggleInfobox:function(e){e&&($(".move-grid").addClass("hidden"),$(".infobox").removeClass("hidden").html(e),$(".play-again").removeClass("hidden"))},announceWinner:function(){this.winner=this.activePlayer;var e=this.winner.get("name")+" wins!";return Utils.debug(e),this.toggleInfobox(e),this.winner},announceDraw:function(){var e="It's a draw!";return this.winner=null,Utils.debug(e),this.toggleInfobox(e),this.winner},placeToken:function(e,i){$(".move-grid").removeClass(e);var n=this.rowCount-1,r=n;for(r=n;r>-1;r--){var t=this.getGrid(r,i),a=e;if(!t.data("active")){t.addClass(a).data("active",!0),Utils.debug(this.activePlayer.get("name")+"'s token was placed at "+r+","+i),this.checkWinner();break}}this.activePlayer="player1"===e?this.player2:this.player1},focusMove:function(e){if(!this.winner){var i=this.activePlayer.get("id");$(e.target).addClass(i)}},outMove:function(e){if(!this.winner){var i=this.activePlayer.get("id");$(e.target).removeClass(i)}},makeMove:function(e){if(!this.winner){var i=$(e.target).data("movenum");i>=0&&this.activePlayer.move(i)}},getGrid:function(e,i){return $("#grid-"+e+"-"+i)}})}();